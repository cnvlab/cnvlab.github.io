<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>Tag: tutorial - Code&amp; Vision</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Code&amp; Vision"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Code&amp; Vision"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Code&amp;amp; Vision"><meta property="og:type" content="blog"><meta property="og:title" content="Code&amp; Vision"><meta property="og:url" content="https://cnvlabs.github.io/"><meta property="og:site_name" content="Code&amp; Vision"><meta property="og:description" content="Code&amp;amp; Vision"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://cnvlabs.github.io/img/og_image.png"><meta property="article:author" content="Wide Stack Developer"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://cnvlabs.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://cnvlabs.github.io"},"headline":"Code& Vision","image":["https://cnvlabs.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Wide Stack Developer"},"publisher":{"@type":"Organization","name":"Code& Vision","logo":{"@type":"ImageObject","url":"https://cnvlabs.github.io/img/logo.svg"}},"description":"Code&amp; Vision"}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Code&amp; Vision" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/tags">Tags</a></li><li class="is-active"><a href="#" aria-current="page">tutorial</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-11-07T15:00:00.000Z" title="2018. 11. 8. 오전 12:00:00">2018-11-08</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-01-20T14:35:47.553Z" title="2023. 1. 20. 오후 11:35:47">2023-01-20</time></span><span class="level-item"><a class="link-muted" href="/categories/CUDA/">CUDA</a></span><span class="level-item">43 minutes read (About 6449 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/11/08/cuda-tutorials-1/">NVIDIA CUDA 기초 튜토리얼 (1)</a></h1><div class="content"><p>NVIDIA 사의 공식 튜토리얼 <code>Fundamentals of Accelerated Computing C/C++</code>을 학습하며 정리한 내용.</p>
<h1 id="Accelerating-Applications-with-CUDA-C-x2F-C"><a href="#Accelerating-Applications-with-CUDA-C-x2F-C" class="headerlink" title="Accelerating Applications with CUDA C&#x2F;C++"></a>Accelerating Applications with CUDA C&#x2F;C++</h1><h2 id="GPU-accelerated-Vs-CPU-only-Applications"><a href="#GPU-accelerated-Vs-CPU-only-Applications" class="headerlink" title="GPU-accelerated Vs. CPU-only Applications"></a>GPU-accelerated Vs. CPU-only Applications</h2><div align="center"><iframe src="https://docs.google.com/presentation/d/e/2PACX-1vTdUbQjoEYAtcPCMX4ZVLa9gE0rbO3ODClJqgtzRaXoFgVmTJrOkXGDAYmA0BsuTEaokTASv84JsKLm/embed?start=false&loop=false&delayms=3000" frameborder="0" width="700" height="430" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true"></iframe></div>



<h2 id="Writing-Application-Code-for-the-GPU"><a href="#Writing-Application-Code-for-the-GPU" class="headerlink" title="Writing Application Code for the GPU"></a>Writing Application Code for the GPU</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CPUFunction</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;This function is defined to run on the CPU.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__global__ <span class="type">void</span> <span class="title">GPUFunction</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;This function is defined to run on the GPU.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">CPUFunction</span>();</span><br><span class="line"></span><br><span class="line">  GPUFunction&lt;&lt;&lt;<span class="number">1</span>, <span class="number">1</span>&gt;&gt;&gt;();</span><br><span class="line">  <span class="built_in">cudaDeviceSynchronize</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>__global__ void GPUFunction()</code>	</p>
<ul>
<li><code>__global__</code>이라는 키워드가 GPU에서 돌아간다는 사실을 명시해준다.</li>
</ul>
</li>
<li><p><code>GPUFunction&lt;&lt;1,1&gt;&gt;();</code></p>
<ul>
<li>GPU에서 작동하는 이러한 함수를 <strong>kernel</strong>이라 부르며, <strong>thread hierarchy</strong>를 명시해준다고 한다.</li>
<li>인자 중 앞의 <code>1</code>은 실행될 쓰레드 그룹의 개수를 명시하며, <code>block</code>이라고 부른다. </li>
<li>인자 중 뒤의 <code>1</code>은 각 <code>block</code> 내에 몇 개의 쓰레드가 실행될 것인지를 명시한다.</li>
</ul>
<p>좀 더 자세한 내용은 뒤에서..</p>
</li>
<li><p><code>cudaDeviceSynchronize();</code></p>
<ul>
<li>이후 계산된 값을 CPU와 synchronize하여 작동하게 하기 위해서는, 이 함수를 사용하여야 한다.</li>
</ul>
</li>
</ul>
<h2 id="Compiling-and-Running-Accelerated-CUDA-Code"><a href="#Compiling-and-Running-Accelerated-CUDA-Code" class="headerlink" title="Compiling and Running Accelerated CUDA Code"></a>Compiling and Running Accelerated CUDA Code</h2><p><code>.c</code> 파일을 <code>gcc</code>로 컴파일하는 것처럼, <code>.cu</code> 파일은 <code>nvcc</code>라는 <a target="_blank" rel="noopener" href="http://docs.nvidia.com/cuda/cuda-compiler-driver-nvcc/index.html"><strong>NVIDIA CUDA Compiler</strong></a>로 컴파일한다. 다음과 같이 쓸 수 있다.</p>
<p><code>nvcc -arch=sm_70 -o out some-CUDA.cu -run</code></p>
<p>옵션은 다음과 같다.</p>
<ul>
<li><code>-arch</code>: 컴파일되는 환경의 GPU 아키텍쳐를 명시해준다. <code>sm_70</code>의 경우 Volta 아키텍쳐를 명시해준다.</li>
<li><code>-o</code>: 아웃풋 파일의 이름을 명시해준다.</li>
<li><code>-run</code>: 편의를 위한 옵션. 이 옵션을 쓰면 컴파일한 바이너리 파일을 실행해준다.</li>
</ul>
<h2 id="CUDA-Thread-Hierarchy"><a href="#CUDA-Thread-Hierarchy" class="headerlink" title="CUDA Thread Hierarchy"></a>CUDA Thread Hierarchy</h2><div align="center"><iframe src="https://docs.google.com/presentation/d/e/2PACX-1vQYti_rVyWNNOccK6Slxd1VqazuqO5IhP17tmk-yTZAQfPEVpF14aZF9Vo3XkrDbFetNLTm_Pnk7JvD/embed?start=false&loop=false&delayms=3000" frameborder="0" width="700" height="430" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true"></iframe></div>

<p>CUDA Thread Hierarchy에서의 용어 좀 더 자세히 설명</p>
<ul>
<li><code>kernel</code>: GPU function을 부르는 용어. <code>kernel</code>은 <code>execution configuration</code>에 따라 실행된다.</li>
<li><code>thread</code>: GPU 작업의 기본 단위. 여러 <code>thread</code>가 병렬적으로 작동한다.</li>
<li><code>block</code>: <code>thread</code>의 모임을 <code>block</code>이라 한다.</li>
<li><code>grid</code>: 주어진 <code>kernel</code>의 <code>execution configuration</code>에서 <code>block</code>들의 모임, 그러니까 전체를 <code>grid</code>라 부른다.</li>
</ul>
<h2 id="CUDA-Provided-Thread-Hierarchy-Variables"><a href="#CUDA-Provided-Thread-Hierarchy-Variables" class="headerlink" title="CUDA-Provided Thread Hierarchy Variables"></a>CUDA-Provided Thread Hierarchy Variables</h2><div align="center"><iframe src="https://docs.google.com/presentation/d/e/2PACX-1vSVS21bI-cje3Cqtxke-LHcvxk1ZxvZF-F35bgHSKfvNsvkGklCeqwlXHCDPJey5meZ1vTVYMqiF0UV/embed?start=false&loop=false&delayms=3000" frameborder="0" width="700" height="430" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true"></iframe></div>

<p>CUDA Thread Hierarchy에서는 미리 정해진 변수를 통해 각 <code>block</code>과 <code>thread</code>에 접근할 수 있다.</p>
<ul>
<li><code>gridDim.x</code>: <code>grid</code> 내에 있는 <code>block</code>의 개수. performWork&lt;&lt;&lt;2,4&gt;&gt;&gt;()와 같은 <code>kernel</code>의 경우 2가 된다.</li>
<li><code>blockIdx.x</code>: <code>grid</code> 내에 있는 <code>block</code>들 중 해당 <code>block</code>의 위치 인덱스. performWork&lt;&lt;&lt;2,4&gt;&gt;&gt;()와 같은 <code>kernel</code>을 실행한다면 <code>0</code>,<code>1</code>이 될 수 있다.</li>
<li><code>blockDim.x</code>: <code>block</code> 내에 있는 <code>thread</code>의 개수. performWork&lt;&lt;&lt;2,4&gt;&gt;&gt;()와 같은 <code>kernel</code>의 경우 <code>4</code>가 된다. 한 <code>grid</code> 내에 있는 모든 <code>block</code>은 같은 수의 <code>thread</code>를 가진다.</li>
<li><code>threadIdx.x</code>: <code>block</code> 내에 있는 <code>thread</code> 중 해당 <code>thread</code>의 위치 인덱스. performWork&lt;&lt;&lt;2,4&gt;&gt;&gt;()와 같은 <code>kernel</code>의 경우 <code>0</code>,<code>1</code>,<code>2</code>,<code>3</code> 중 하나가 된다.</li>
</ul>
<h2 id="Accelerating-For-Loops"><a href="#Accelerating-For-Loops" class="headerlink" title="Accelerating For Loops"></a>Accelerating For Loops</h2><p>반복문을 가속화하는 법.</p>
<h3 id="Exercise-Accelerating-a-For-Loop-with-a-Single-Block-of-Threads"><a href="#Exercise-Accelerating-a-For-Loop-with-a-Single-Block-of-Threads" class="headerlink" title="Exercise: Accelerating a For Loop with a Single Block of Threads"></a>Exercise: Accelerating a For Loop with a Single Block of Threads</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Refactor `loop` to be a CUDA Kernel. The new kernel should</span></span><br><span class="line"><span class="comment"> * only do the work of 1 iteration of the original loop.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">loop</span><span class="params">(<span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This is iteration number %d\n&quot;</span>, i);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * When refactoring `loop` to launch as a kernel, be sure</span></span><br><span class="line"><span class="comment">   * to use the execution configuration to control how many</span></span><br><span class="line"><span class="comment">   * &quot;iterations&quot; to perform.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * For this exercise, only use 1 block of threads.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> N = <span class="number">10</span>;</span><br><span class="line">  <span class="built_in">loop</span>(N);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>이런 반복문을 어떻게 GPU로 가속할 수 있을까? 병렬화를 하기 위해서는 2가지 단계를 꼭 거쳐야 한다:</p>
<ul>
<li><code>kernel</code>은 해당 반복문에서 딱 한 번의 반복 작업만 하도록 설계되어야 한다.</li>
<li><code>kernel</code>이 다른 <code>kernel</code>에 대해서 알지 못하기 때문에, <code>execution configuration</code>이 해당 반복문에서 반복되는 작업의 수에 맞춰 선언되어야 한다.</li>
</ul>
<p>우리가 위에서 배운 Thread Hierarchy Variable을 활용하면 이를 달성할 수 있다.</p>
<p><strong>Solution)</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Refactor `loop` to be a CUDA Kernel. The new kernel should</span></span><br><span class="line"><span class="comment"> * only do the work of 1 iteration of the original loop.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function">__global__ <span class="type">void</span> <span class="title">loop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;This is iteration number %d\n&quot;</span>, threadIdx.x);</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * When refactoring `loop` to launch as a kernel, be sure</span></span><br><span class="line"><span class="comment">   * to use the execution configuration to control how many</span></span><br><span class="line"><span class="comment">   * &quot;iterations&quot; to perform.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * For this exercise, only use 1 block of threads.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> N = <span class="number">10</span>;</span><br><span class="line">  loop&lt;&lt;&lt;<span class="number">1</span>,N&gt;&gt;&gt;();</span><br><span class="line">  <span class="built_in">cudaDeviceSynchronize</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Coordinating-Parallel-Threads"><a href="#Coordinating-Parallel-Threads" class="headerlink" title="Coordinating Parallel Threads"></a>Coordinating Parallel Threads</h2><div align="center"><iframe src="https://docs.google.com/presentation/d/e/2PACX-1vSfi8LAinJ1RqTzlB2vRsAcDzCCk9gZov5rQODN5rtRMPt57UizCVv5LSVZ5WLxGtrsMm7FIkLb0wMR/embed?start=false&loop=false&delayms=3000" frameborder="0" width="700" height="430" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true"></iframe></div>

<p>각 <code>block</code>에 존재할 수 있는 <code>thread</code>의 개수는 최대 1024개로 한계가 있다. 따라서 병렬처리의 효과를 더 크게 누리기 위해서는 여러 <code>block</code>들 간의 coordinate를 잘 해야 한다.</p>
<p>GPU <code>thread</code>에 data를 할당하기 위해, 각 <code>thread</code>의 인덱스를 활용한 데이터 분배 접근 전략을 활용한다.</p>
<p>각 <code>block</code>의 사이즈는 <code>blockDim.x</code>로 알 수 있고, 인덱스는 <code>blockIdx.x</code>로 접근할 수 있다. 또 각 <code>thread</code>의 인덱스는 <code>threadIdx.x</code>로 접근할 수 있다.</p>
<p>따라서 <code>threadIdx.x</code> + <code>blockIdx.x</code> * <code>blockDim.x</code>라는 공식을 활용하여 데이터를 <code>thread</code>에 매핑할 수 있다.</p>
<h3 id="Exercise-Accelerating-a-For-Loop-with-Multiple-Blocks-of-Threads"><a href="#Exercise-Accelerating-a-For-Loop-with-Multiple-Blocks-of-Threads" class="headerlink" title="Exercise: Accelerating a For Loop with Multiple Blocks of Threads"></a>Exercise: Accelerating a For Loop with Multiple Blocks of Threads</h3><p>아까 위에서 병렬화 한 반복문을, 이번에는 최소 2개 이상의 <code>block</code>을 활용하여 병렬화시켜보자.</p>
<h2 id="Allocating-Memory-to-be-accessed-on-the-GPU-and-the-CPU"><a href="#Allocating-Memory-to-be-accessed-on-the-GPU-and-the-CPU" class="headerlink" title="Allocating Memory to be accessed on the GPU and the CPU"></a>Allocating Memory to be accessed on the GPU and the CPU</h2><p>CPU-only application에서는 C가 <code>malloc</code>과 <code>free</code>를 사용해 메모리를 할당하고 해제하지만, GPU 가속을 할 때는 대신 <code>cudaMallocManaged</code>와 <code>cudaFree</code>를 사용한다. 사용 예시는 다음과 같으니 비교해보자.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CPU-only</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> N = <span class="number">2</span>&lt;&lt;<span class="number">20</span>;</span><br><span class="line"><span class="type">size_t</span> size = N * <span class="built_in">sizeof</span>(<span class="type">int</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> *a;</span><br><span class="line">a = (<span class="type">int</span> *)<span class="built_in">malloc</span>(size);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use `a` in CPU-only program.</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(a);</span><br><span class="line"><span class="comment">// Accelerated</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> N = <span class="number">2</span>&lt;&lt;<span class="number">20</span>;</span><br><span class="line"><span class="type">size_t</span> size = N * <span class="built_in">sizeof</span>(<span class="type">int</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> *a;</span><br><span class="line"><span class="comment">// Note the address of `a` is passed as first argument.</span></span><br><span class="line"><span class="built_in">cudaMallocManaged</span>(&amp;a, size);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use `a` on the CPU and/or on any GPU in the accelerated system.</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cudaFree</span>(a);</span><br></pre></td></tr></table></figure>



<h3 id="Exercise-Array-Manipulation-on-both-the-Host-and-Device"><a href="#Exercise-Array-Manipulation-on-both-the-Host-and-Device" class="headerlink" title="Exercise: Array Manipulation on both the Host and Device"></a>Exercise: Array Manipulation on both the Host and Device</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Initialize array values on the host.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(<span class="type">int</span> *a, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    a[i] = i;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Double elements in parallel on the GPU.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function">__global__</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">doubleElements</span><span class="params">(<span class="type">int</span> *a, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  i = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">  <span class="keyword">if</span> (i &lt; N)</span><br><span class="line">  &#123;</span><br><span class="line">    a[i] *= <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Check all elements have been doubled on the host.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">checkElementsAreDoubled</span><span class="params">(<span class="type">int</span> *a, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (a[i] != i*<span class="number">2</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> N = <span class="number">100</span>;</span><br><span class="line">  <span class="type">int</span> *a;</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> size = N * <span class="built_in">sizeof</span>(<span class="type">int</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Refactor this memory allocation to provide a pointer</span></span><br><span class="line"><span class="comment">   * `a` that can be used on both the host and the device.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  a = (<span class="type">int</span> *)<span class="built_in">malloc</span>(size);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">init</span>(a, N);</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> threads_per_block = <span class="number">10</span>;</span><br><span class="line">  <span class="type">size_t</span> number_of_blocks = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * This launch will not work until the pointer `a` is also</span></span><br><span class="line"><span class="comment">   * available to the device.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  doubleElements&lt;&lt;&lt;number_of_blocks, threads_per_block&gt;&gt;&gt;(a, N);</span><br><span class="line">  <span class="built_in">cudaDeviceSynchronize</span>();</span><br><span class="line"></span><br><span class="line">  <span class="type">bool</span> areDoubled = <span class="built_in">checkElementsAreDoubled</span>(a, N);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;All elements were doubled? %s\n&quot;</span>, areDoubled ? <span class="string">&quot;TRUE&quot;</span> : <span class="string">&quot;FALSE&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Refactor to free memory that has been allocated to be</span></span><br><span class="line"><span class="comment">   * accessed by both the host and the device.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>위 코드를 배열 포인터 <code>a</code>가 CPU와 GPU 코드에서 모두 쓰일 수 있게, 또 <code>a</code>를 정확히 메모리 해제해야 한다는 점에 유의해서 고쳐보자.</p>
<p><strong>Solution)</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(<span class="type">int</span> *a, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    a[i] = i;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__global__</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">doubleElements</span><span class="params">(<span class="type">int</span> *a, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  i = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">  <span class="keyword">if</span> (i &lt; N)</span><br><span class="line">  &#123;</span><br><span class="line">    a[i] *= <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">checkElementsAreDoubled</span><span class="params">(<span class="type">int</span> *a, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (a[i] != i*<span class="number">2</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> N = <span class="number">100</span>;</span><br><span class="line">  <span class="type">int</span> *a;</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> size = N * <span class="built_in">sizeof</span>(<span class="type">int</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">cudaMallocManaged</span>(&amp;a, size);</span><br><span class="line">  <span class="built_in">init</span>(a, N);</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> threads_per_block = <span class="number">10</span>;</span><br><span class="line">  <span class="type">size_t</span> number_of_blocks = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  doubleElements&lt;&lt;&lt;number_of_blocks, threads_per_block&gt;&gt;&gt;(a, N);</span><br><span class="line">  <span class="built_in">cudaDeviceSynchronize</span>();</span><br><span class="line"></span><br><span class="line">  <span class="type">bool</span> areDoubled = <span class="built_in">checkElementsAreDoubled</span>(a, N);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;All elements were doubled? %s\n&quot;</span>, areDoubled ? <span class="string">&quot;TRUE&quot;</span> : <span class="string">&quot;FALSE&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">cudaFree</span>(a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Grid-Size-Work-Amount-Mismatch"><a href="#Grid-Size-Work-Amount-Mismatch" class="headerlink" title="Grid Size Work Amount Mismatch"></a>Grid Size Work Amount Mismatch</h2><p>우리가 사용하려는 데이터가 <code>grid</code> 사이즈에 딱 맞으면 상관 없지만, 만약 그것보다 부족한 경우 사이즈가 맞지 않는다는 문제가 발생한다. e.g.) <code>grid</code> 내에 <code>thread</code> 개수가 8개인데 사용할 데이터는 5개밖에 없으면  <code>threadIdx.x</code> + <code>blockIdx.x</code> * <code>blockDim.x</code> 공식으로 할당할 때 5,6,7번은 문제가 생긴다.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__global__ <span class="title">some_kernel</span><span class="params">(<span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> idx = threadIdx.x + blockIdx.x * blockDim.x;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (idx &lt; N) <span class="comment">// Check to make sure `idx` maps to some value within `N`</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Only do work if it does</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Assume `N` is known</span></span><br><span class="line"><span class="type">int</span> N = <span class="number">100000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Assume we have a desire to set `threads_per_block` exactly to `256`</span></span><br><span class="line"><span class="type">size_t</span> threads_per_block = <span class="number">256</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Ensure there are at least `N` threads in the grid, but only 1 block&#x27;s worth extra</span></span><br><span class="line"><span class="type">size_t</span> number_of_blocks = (N + threads_per_block - <span class="number">1</span>) / threads_per_block;</span><br><span class="line"></span><br><span class="line">some_kernel&lt;&lt;&lt;number_of_blocks, threads_per_block&gt;&gt;&gt;(N);</span><br></pre></td></tr></table></figure>

<p>그래서 위와 같이 <code>some_kernel</code> 함수의 <code>if</code>문처럼 인덱스가 데이터의 크기보다 작을 때만 특정 기능을 실행하도록 설정해주면 된다.</p>
<h3 id="Exercise-Accelerating-a-For-Loop-with-a-Mismatched-Execution-Configuration"><a href="#Exercise-Accelerating-a-For-Loop-with-a-Mismatched-Execution-Configuration" class="headerlink" title="Exercise: Accelerating a For Loop with a Mismatched Execution Configuration"></a>Exercise: Accelerating a For Loop with a Mismatched Execution Configuration</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Currently, `initializeElementsTo`, if executed in a thread whose</span></span><br><span class="line"><span class="comment"> * `i` is calculated to be greater than `N`, will try to access a value</span></span><br><span class="line"><span class="comment"> * outside the range of `a`.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Refactor the kernel defintition to prevent our of range accesses.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function">__global__ <span class="type">void</span> <span class="title">initializeElementsTo</span><span class="params">(<span class="type">int</span> initialValue, <span class="type">int</span> *a, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> i = threadIdx.x + blockIdx.x * blockDim.x;</span><br><span class="line">  a[i] = initialValue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Do not modify `N`.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> N = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> *a;</span><br><span class="line">  <span class="type">size_t</span> size = N * <span class="built_in">sizeof</span>(<span class="type">int</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">cudaMallocManaged</span>(&amp;a, size);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Assume we have reason to want the number of threads</span></span><br><span class="line"><span class="comment">   * fixed at `256`: do not modify `threads_per_block`.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> threads_per_block = <span class="number">256</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Assign a value to `number_of_blocks` that will</span></span><br><span class="line"><span class="comment">   * allow for a working execution configuration given</span></span><br><span class="line"><span class="comment">   * the fixed values for `N` and `threads_per_block`.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> number_of_blocks = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> initialValue = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">  initializeElementsTo&lt;&lt;&lt;number_of_blocks, threads_per_block&gt;&gt;&gt;(initialValue, a, N);</span><br><span class="line">  <span class="built_in">cudaDeviceSynchronize</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Check to make sure all values in `a`, were initialized.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span>(a[i] != initialValue)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;FAILURE: target value: %d\t a[%d]: %d\n&quot;</span>, initialValue, i, a[i]);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;SUCCESS!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">cudaFree</span>(a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>이 코드는 1000개의 integer를 <code>cudaMallocManaged</code>를 활용해 메모리 할당하고 있고, <code>thread_per_blocks</code> 라는 이름의 변수로 <code>block</code> 당 최대 <code>thread</code> 개수를 정의하고 있다. 이에 따라 <code>number_of_blocks</code> 변수에 필요한 <code>block</code>의 개수를 구해 할당해주고, <code>initializeElementsTo</code> 함수에다 데이터 수보다 인덱스가 넘치는 경우 예외를 처리해주는 내용의 코드를 추가해주자.</p>
<p><strong>Solution)</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Currently, `initializeElementsTo`, if executed in a thread whose</span></span><br><span class="line"><span class="comment"> * `i` is calculated to be greater than `N`, will try to access a value</span></span><br><span class="line"><span class="comment"> * outside the range of `a`.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Refactor the kernel defintition to prevent our of range accesses.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function">__global__ <span class="type">void</span> <span class="title">initializeElementsTo</span><span class="params">(<span class="type">int</span> initialValue, <span class="type">int</span> *a, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> i = threadIdx.x + blockIdx.x * blockDim.x;</span><br><span class="line">  <span class="keyword">if</span>(i &lt; N)&#123;</span><br><span class="line">      a[i] = initialValue;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Do not modify `N`.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> N = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> *a;</span><br><span class="line">  <span class="type">size_t</span> size = N * <span class="built_in">sizeof</span>(<span class="type">int</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">cudaMallocManaged</span>(&amp;a, size);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Assume we have reason to want the number of threads</span></span><br><span class="line"><span class="comment">   * fixed at `256`: do not modify `threads_per_block`.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> threads_per_block = <span class="number">256</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Assign a value to `number_of_blocks` that will</span></span><br><span class="line"><span class="comment">   * allow for a working execution configuration given</span></span><br><span class="line"><span class="comment">   * the fixed values for `N` and `threads_per_block`.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> number_of_blocks = (N + threads_per_block - <span class="number">1</span>) / threads_per_block;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> initialValue = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">  initializeElementsTo&lt;&lt;&lt;number_of_blocks, threads_per_block&gt;&gt;&gt;(initialValue, a, N);</span><br><span class="line">  <span class="built_in">cudaDeviceSynchronize</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Check to make sure all values in `a`, were initialized.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span>(a[i] != initialValue)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;FAILURE: target value: %d\t a[%d]: %d\n&quot;</span>, initialValue, i, a[i]);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;SUCCESS!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">cudaFree</span>(a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Grid-Stride-Loops"><a href="#Grid-Stride-Loops" class="headerlink" title="Grid-Stride Loops"></a>Grid-Stride Loops</h2><div align="center"><iframe src="https://docs.google.com/presentation/d/e/2PACX-1vTSfcPagyv7ObRnhygFnKrvDIDa-wUuc3yR-qs7xd4gQxProMOqXzNqe8y9vz711cLIbPp1qYJc7R3l/embed?start=false&loop=false&delayms=3000" frameborder="0" width="700" height="430" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true"></iframe></div>

<p>이번에는 데이터의 개수가 <code>grid</code> 내에 존재하는 <code>thread</code>의 개수보다 많은 경우이다. 이 경우 남은 데이터들을 처리해줄 수 없기 때문에 <code>grid-stride loops</code>라는 방법을 사용한다. </p>
<p>이 방법은 <code>kernel</code> 내에서 반복문을 사용하는 것인데, 매 반복마다 <code>grid</code> 내의 <code>thread</code>의 개수인 <code>gridDim.x</code> * <code>blockDim.x</code>만큼 인덱스에 더해주면서 모든 데이터를 처리하는 방법이다.</p>
<h3 id="Exercise-Use-a-Grid-Stride-Loop-to-Manipulate-an-Array-Larger-than-the-Grid"><a href="#Exercise-Use-a-Grid-Stride-Loop-to-Manipulate-an-Array-Larger-than-the-Grid" class="headerlink" title="Exercise: Use a Grid-Stride Loop to Manipulate an Array Larger than the Grid"></a>Exercise: Use a Grid-Stride Loop to Manipulate an Array Larger than the Grid</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(<span class="type">int</span> *a, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    a[i] = i;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * In the current application, `N` is larger than the grid.</span></span><br><span class="line"><span class="comment"> * Refactor this kernel to use a grid-stride loop in order that</span></span><br><span class="line"><span class="comment"> * each parallel thread work on more than one element of the array.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function">__global__</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">doubleElements</span><span class="params">(<span class="type">int</span> *a, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  i = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">  <span class="keyword">if</span> (i &lt; N)</span><br><span class="line">  &#123;</span><br><span class="line">    a[i] *= <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">checkElementsAreDoubled</span><span class="params">(<span class="type">int</span> *a, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (a[i] != i*<span class="number">2</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * `N` is greater than the size of the grid (see below).</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> N = <span class="number">10000</span>;</span><br><span class="line">  <span class="type">int</span> *a;</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> size = N * <span class="built_in">sizeof</span>(<span class="type">int</span>);</span><br><span class="line">  <span class="built_in">cudaMallocManaged</span>(&amp;a, size);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">init</span>(a, N);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * The size of this grid is 256*32 = 8192.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> threads_per_block = <span class="number">256</span>;</span><br><span class="line">  <span class="type">size_t</span> number_of_blocks = <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">  doubleElements&lt;&lt;&lt;number_of_blocks, threads_per_block&gt;&gt;&gt;(a, N);</span><br><span class="line">  <span class="built_in">cudaDeviceSynchronize</span>();</span><br><span class="line"></span><br><span class="line">  <span class="type">bool</span> areDoubled = <span class="built_in">checkElementsAreDoubled</span>(a, N);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;All elements were doubled? %s\n&quot;</span>, areDoubled ? <span class="string">&quot;TRUE&quot;</span> : <span class="string">&quot;FALSE&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">cudaFree</span>(a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>grid</code> 내의 <code>thread</code> 개수는 256*32 &#x3D; 8192개지만 전체 데이터는 10000개로 이를 초과한다. <code>doubleElements</code> 커널을 <code>grid-stride loops</code> 방식으로 수정하여 모든 데이터를 연산할 수 있게 해보자.</p>
<p><strong>Solution)</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(<span class="type">int</span> *a, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    a[i] = i;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__global__</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">doubleElements</span><span class="params">(<span class="type">int</span> *a, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Use a grid-stride loop so each thread does work</span></span><br><span class="line"><span class="comment">   * on more than one element in the array.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> idx = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">  <span class="type">int</span> stride = gridDim.x * blockDim.x;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = idx; i &lt; N; i += stride)</span><br><span class="line">  &#123;</span><br><span class="line">    a[i] *= <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">checkElementsAreDoubled</span><span class="params">(<span class="type">int</span> *a, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (a[i] != i*<span class="number">2</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> N = <span class="number">10000</span>;</span><br><span class="line">  <span class="type">int</span> *a;</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> size = N * <span class="built_in">sizeof</span>(<span class="type">int</span>);</span><br><span class="line">  <span class="built_in">cudaMallocManaged</span>(&amp;a, size);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">init</span>(a, N);</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> threads_per_block = <span class="number">256</span>;</span><br><span class="line">  <span class="type">size_t</span> number_of_blocks = <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">  doubleElements&lt;&lt;&lt;number_of_blocks, threads_per_block&gt;&gt;&gt;(a, N);</span><br><span class="line">  <span class="built_in">cudaDeviceSynchronize</span>();</span><br><span class="line"></span><br><span class="line">  <span class="type">bool</span> areDoubled = <span class="built_in">checkElementsAreDoubled</span>(a, N);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;All elements were doubled? %s\n&quot;</span>, areDoubled ? <span class="string">&quot;TRUE&quot;</span> : <span class="string">&quot;FALSE&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">cudaFree</span>(a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Error-Handling"><a href="#Error-Handling" class="headerlink" title="Error Handling"></a>Error Handling</h2><p>어느 어플리케이션에서나 <code>Error Handling</code>은 중요하다. 대부분의 CUDA 함수는 <code>cudaError_t</code>라는 자료형으로 결과값을 반환하는데, 이걸 확인하면 에러가 발생했는지 아닌지를 확인할 수 있다. <code>cudaMallocManaged</code> 함수의 경우 다음과 같다.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cudaError_t err;</span><br><span class="line">err = <span class="built_in">cudaMallocManaged</span>(&amp;a, N)                    <span class="comment">// Assume the existence of `a` and `N`.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (err != cudaSuccess)                           <span class="comment">// `cudaSuccess` is provided by CUDA.</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Error: %s\n&quot;</span>, <span class="built_in">cudaGetErrorString</span>(err)); <span class="comment">// `cudaGetErrorString` is provided by CUDA.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>그런데 <code>kernel</code> 함수는 void 함수로 짜서 <code>cudaError_t</code>를 반환하지 않는데, 이 경우 CUDA는 <code>cudaGetLastError</code> 함수를 제공한다. </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This launch should cause an error, but the kernel itself</span></span><br><span class="line"><span class="comment"> * cannot return it.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">someKernel&lt;&lt;&lt;<span class="number">1</span>, <span class="number">-1</span>&gt;&gt;&gt;();  <span class="comment">// -1 is not a valid number of threads.</span></span><br><span class="line"></span><br><span class="line">cudaError_t err;</span><br><span class="line">err = <span class="built_in">cudaGetLastError</span>(); <span class="comment">// `cudaGetLastError` will return the error from above.</span></span><br><span class="line"><span class="keyword">if</span> (err != cudaSuccess)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Error: %s\n&quot;</span>, <span class="built_in">cudaGetErrorString</span>(err));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>만약 asynchronous하게 발생하는 에러를 잡고 싶다면(예를 들면 asynchronous하게 작동하는 <code>kernel</code>) synchronize하게 하는 CUDA runtime API call (예를 들면 <code>cudaDeviceSynchronize</code>)을 잘 체크해서 잡아내야 한다.</p>
<h3 id="Exercise-Add-Error-Handling"><a href="#Exercise-Add-Error-Handling" class="headerlink" title="Exercise: Add Error Handling"></a>Exercise: Add Error Handling</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(<span class="type">int</span> *a, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    a[i] = i;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__global__</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">doubleElements</span><span class="params">(<span class="type">int</span> *a, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> idx = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">  <span class="type">int</span> stride = gridDim.x * blockDim.x;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = idx; i &lt; N + stride; i += stride)</span><br><span class="line">  &#123;</span><br><span class="line">    a[i] *= <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">checkElementsAreDoubled</span><span class="params">(<span class="type">int</span> *a, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (a[i] != i*<span class="number">2</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Add error handling to this source code to learn what errors</span></span><br><span class="line"><span class="comment">   * exist, and then correct them. Googling error messages may be</span></span><br><span class="line"><span class="comment">   * of service if actions for resolving them are not clear to you.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> N = <span class="number">10000</span>;</span><br><span class="line">  <span class="type">int</span> *a;</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> size = N * <span class="built_in">sizeof</span>(<span class="type">int</span>);</span><br><span class="line">  <span class="built_in">cudaMallocManaged</span>(&amp;a, size);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">init</span>(a, N);</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> threads_per_block = <span class="number">2048</span>;</span><br><span class="line">  <span class="type">size_t</span> number_of_blocks = <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">  doubleElements&lt;&lt;&lt;number_of_blocks, threads_per_block&gt;&gt;&gt;(a, N);</span><br><span class="line">  <span class="built_in">cudaDeviceSynchronize</span>();</span><br><span class="line"></span><br><span class="line">  <span class="type">bool</span> areDoubled = <span class="built_in">checkElementsAreDoubled</span>(a, N);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;All elements were doubled? %s\n&quot;</span>, areDoubled ? <span class="string">&quot;TRUE&quot;</span> : <span class="string">&quot;FALSE&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">cudaFree</span>(a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>Solution)</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(<span class="type">int</span> *a, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    a[i] = i;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__global__</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">doubleElements</span><span class="params">(<span class="type">int</span> *a, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> idx = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">  <span class="type">int</span> stride = gridDim.x * blockDim.x;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * The previous code (now commented out) attempted</span></span><br><span class="line"><span class="comment">   * to access an element outside the range of `a`.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// for (int i = idx; i &lt; N + stride; i += stride)</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = idx; i &lt; N; i += stride)</span><br><span class="line">  &#123;</span><br><span class="line">    a[i] *= <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">checkElementsAreDoubled</span><span class="params">(<span class="type">int</span> *a, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (a[i] != i*<span class="number">2</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> N = <span class="number">10000</span>;</span><br><span class="line">  <span class="type">int</span> *a;</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> size = N * <span class="built_in">sizeof</span>(<span class="type">int</span>);</span><br><span class="line">  <span class="built_in">cudaMallocManaged</span>(&amp;a, size);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">init</span>(a, N);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * The previous code (now commented out) attempted to launch</span></span><br><span class="line"><span class="comment">   * the kernel with more than the maximum number of threads per</span></span><br><span class="line"><span class="comment">   * block, which is 1024.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> threads_per_block = <span class="number">1024</span>;</span><br><span class="line">  <span class="comment">/* size_t threads_per_block = 2048; */</span></span><br><span class="line">  <span class="type">size_t</span> number_of_blocks = <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">  cudaError_t syncErr, asyncErr;</span><br><span class="line"></span><br><span class="line">  doubleElements&lt;&lt;&lt;number_of_blocks, threads_per_block&gt;&gt;&gt;(a, N);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Catch errors for both the kernel launch above and any</span></span><br><span class="line"><span class="comment">   * errors that occur during the asynchronous `doubleElements`</span></span><br><span class="line"><span class="comment">   * kernel execution.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  syncErr = <span class="built_in">cudaGetLastError</span>();</span><br><span class="line">  asyncErr = <span class="built_in">cudaDeviceSynchronize</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Print errors should they exist.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (syncErr != cudaSuccess) <span class="built_in">printf</span>(<span class="string">&quot;Error: %s\n&quot;</span>, <span class="built_in">cudaGetErrorString</span>(syncErr));</span><br><span class="line">  <span class="keyword">if</span> (asyncErr != cudaSuccess) <span class="built_in">printf</span>(<span class="string">&quot;Error: %s\n&quot;</span>, <span class="built_in">cudaGetErrorString</span>(asyncErr));</span><br><span class="line"></span><br><span class="line">  <span class="type">bool</span> areDoubled = <span class="built_in">checkElementsAreDoubled</span>(a, N);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;All elements were doubled? %s\n&quot;</span>, areDoubled ? <span class="string">&quot;TRUE&quot;</span> : <span class="string">&quot;FALSE&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">cudaFree</span>(a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="CUDA-Error-Handling-Function"><a href="#CUDA-Error-Handling-Function" class="headerlink" title="CUDA Error Handling Function"></a>CUDA Error Handling Function</h2><p>다음은 에러를 확인하기 편하게 해주는 매크로 함수다. 다른 exercise를 풀 때 편하게 사용하면 된다.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> cudaError_t <span class="title">checkCuda</span><span class="params">(cudaError_t result)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (result != cudaSuccess) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;CUDA Runtime Error: %s\n&quot;</span>, <span class="built_in">cudaGetErrorString</span>(result));</span><br><span class="line">    <span class="built_in">assert</span>(result == cudaSuccess);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The macro can be wrapped around any function returning</span></span><br><span class="line"><span class="comment"> * a value of type `cudaError_t`.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">checkCuda</span>( <span class="built_in">cudaDeviceSynchronize</span>() )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="요약"><a href="#요약" class="headerlink" title="요약"></a>요약</h2><p>Accelerating Applications with CUDA C&#x2F;C++에서 배운 내용 요약.</p>
<ul>
<li>Write, compile, and run C&#x2F;C++ programs that both call CPU functions and <strong>launch</strong> GPU <strong>kernels</strong>.</li>
<li>Control parallel <strong>thread hierarchy</strong> using <strong>execution configuration</strong>.</li>
<li>Refactor serial loops to execute their iterations in parallel on a GPU.</li>
<li>Allocate and free memory available to both CPUs and GPUs.</li>
<li>Handle errors generated by CUDA code.</li>
</ul>
<h3 id="Final-Exercise-Accelerate-Vector-Addition-Application"><a href="#Final-Exercise-Accelerate-Vector-Addition-Application" class="headerlink" title="Final Exercise: Accelerate Vector Addition Application"></a>Final Exercise: Accelerate Vector Addition Application</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">initWith</span><span class="params">(<span class="type">float</span> num, <span class="type">float</span> *a, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    a[i] = num;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">addVectorsInto</span><span class="params">(<span class="type">float</span> *result, <span class="type">float</span> *a, <span class="type">float</span> *b, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    result[i] = a[i] + b[i];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">checkElementsAre</span><span class="params">(<span class="type">float</span> target, <span class="type">float</span> *array, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span>(array[i] != target)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;FAIL: array[%d] - %0.0f does not equal %0.0f\n&quot;</span>, i, array[i], target);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;SUCCESS! All values added correctly.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">int</span> N = <span class="number">2</span>&lt;&lt;<span class="number">20</span>;</span><br><span class="line">  <span class="type">size_t</span> size = N * <span class="built_in">sizeof</span>(<span class="type">float</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> *a;</span><br><span class="line">  <span class="type">float</span> *b;</span><br><span class="line">  <span class="type">float</span> *c;</span><br><span class="line"></span><br><span class="line">  a = (<span class="type">float</span> *)<span class="built_in">malloc</span>(size);</span><br><span class="line">  b = (<span class="type">float</span> *)<span class="built_in">malloc</span>(size);</span><br><span class="line">  c = (<span class="type">float</span> *)<span class="built_in">malloc</span>(size);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">initWith</span>(<span class="number">3</span>, a, N);</span><br><span class="line">  <span class="built_in">initWith</span>(<span class="number">4</span>, b, N);</span><br><span class="line">  <span class="built_in">initWith</span>(<span class="number">0</span>, c, N);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">addVectorsInto</span>(c, a, b, N);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">checkElementsAre</span>(<span class="number">7</span>, c, N);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(a);</span><br><span class="line">  <span class="built_in">free</span>(b);</span><br><span class="line">  <span class="built_in">free</span>(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>위 코드는 CPU로만 작동하는 벡터 더하기 어플리케이션이다. 여기 있는 <code>addVectorsInto</code> 함수를 CUDA <code>kernel</code>로 만들어 GPU 병렬 연산을 할 수 있게 만들어보자. 다음을 유의해서 코드를 짜보자.</p>
<ul>
<li><code>addVectorsInto</code>를 CUDA <code>kernel</code>로 만들기</li>
<li><code>addVectorsInto</code>가 CUDA <code>kernel</code>로 작동하는 적절한 execution configuration을 찾고 실행하기</li>
<li>메모리 할당과 해제를 적절히 해서 <code>a</code>, <code>b</code>, <code>result</code> 벡터가 CPU&#x2F;GPU에서 모두 접근 가능하도록 하기</li>
<li><code>addVectorsInto</code>를 리팩토링하자: it will be launched inside of a single thread, and only needs to do one thread’s worth of work on the input vectors. Be certain the thread will never try to access elements outside the range of the input vectors, and take care to note whether or not the thread needs to do work on more than one element of the input vectors.</li>
<li>CUDA 코드가 잘못될 수 있는 부분에 적절히 error handling을 하자.</li>
</ul>
<p><strong>Solution)</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> cudaError_t <span class="title">checkCuda</span><span class="params">(cudaError_t result)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (result != cudaSuccess) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;CUDA Runtime Error: %s\n&quot;</span>, <span class="built_in">cudaGetErrorString</span>(result));</span><br><span class="line">    <span class="built_in">assert</span>(result == cudaSuccess);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">initWith</span><span class="params">(<span class="type">float</span> num, <span class="type">float</span> *a, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    a[i] = num;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__global__</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">addVectorsInto</span><span class="params">(<span class="type">float</span> *result, <span class="type">float</span> *a, <span class="type">float</span> *b, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> index = threadIdx.x + blockIdx.x * blockDim.x;</span><br><span class="line">  <span class="type">int</span> stride = blockDim.x * gridDim.x;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i = index; i &lt; N; i += stride)</span><br><span class="line">  &#123;</span><br><span class="line">    result[i] = a[i] + b[i];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">checkElementsAre</span><span class="params">(<span class="type">float</span> target, <span class="type">float</span> *array, <span class="type">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span>(array[i] != target)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;FAIL: array[%d] - %0.0f does not equal %0.0f\n&quot;</span>, i, array[i], target);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;SUCCESS! All values added correctly.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">int</span> N = <span class="number">2</span>&lt;&lt;<span class="number">20</span>;</span><br><span class="line">  <span class="type">size_t</span> size = N * <span class="built_in">sizeof</span>(<span class="type">float</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> *a;</span><br><span class="line">  <span class="type">float</span> *b;</span><br><span class="line">  <span class="type">float</span> *c;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">checkCuda</span>( <span class="built_in">cudaMallocManaged</span>(&amp;a, size) );</span><br><span class="line">  <span class="built_in">checkCuda</span>( <span class="built_in">cudaMallocManaged</span>(&amp;b, size) );</span><br><span class="line">  <span class="built_in">checkCuda</span>( <span class="built_in">cudaMallocManaged</span>(&amp;c, size) );</span><br><span class="line"></span><br><span class="line">  <span class="built_in">initWith</span>(<span class="number">3</span>, a, N);</span><br><span class="line">  <span class="built_in">initWith</span>(<span class="number">4</span>, b, N);</span><br><span class="line">  <span class="built_in">initWith</span>(<span class="number">0</span>, c, N);</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> threadsPerBlock;</span><br><span class="line">  <span class="type">size_t</span> numberOfBlocks;</span><br><span class="line"></span><br><span class="line">  threadsPerBlock = <span class="number">256</span>;</span><br><span class="line">  numberOfBlocks = (N + threadsPerBlock - <span class="number">1</span>) / threadsPerBlock;</span><br><span class="line"></span><br><span class="line">  addVectorsInto&lt;&lt;&lt;numberOfBlocks, threadsPerBlock&gt;&gt;&gt;(c, a, b, N);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">checkCuda</span>( <span class="built_in">cudaGetLastError</span>() );</span><br><span class="line">  <span class="built_in">checkCuda</span>( <span class="built_in">cudaDeviceSynchronize</span>() );</span><br><span class="line"></span><br><span class="line">  <span class="built_in">checkElementsAre</span>(<span class="number">7</span>, c, N);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">checkCuda</span>( <span class="built_in">cudaFree</span>(a) );</span><br><span class="line">  <span class="built_in">checkCuda</span>( <span class="built_in">cudaFree</span>(b) );</span><br><span class="line">  <span class="built_in">checkCuda</span>( <span class="built_in">cudaFree</span>(c) );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Advanced-Content"><a href="#Advanced-Content" class="headerlink" title="Advanced Content"></a>Advanced Content</h2><p>The following exercises provide additional challenge for those with time and interest. They require the use of more advanced techniques, and provide less scaffolding. They are difficult and excellent for your development.</p>
<h3 id="Grids-and-Blocks-of-2-and-3-Dimensions"><a href="#Grids-and-Blocks-of-2-and-3-Dimensions" class="headerlink" title="Grids and Blocks of 2 and 3 Dimensions"></a>Grids and Blocks of 2 and 3 Dimensions</h3><p>Grids and blocks can be defined to have up to 3 dimensions. Defining them with multiple dimensions does not impact their performance in any way, but can be very helpful when dealing with data that has multiple dimensions, for example, 2d matrices. To define either grids or blocks with two or 3 dimensions, use CUDA’s <code>dim3</code> type as such:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">dim3 <span class="title">threads_per_block</span><span class="params">(<span class="number">16</span>, <span class="number">16</span>, <span class="number">1</span>)</span></span>;</span><br><span class="line"><span class="function">dim3 <span class="title">number_of_blocks</span><span class="params">(<span class="number">16</span>, <span class="number">16</span>, <span class="number">1</span>)</span></span>;</span><br><span class="line">someKernel&lt;&lt;&lt;number_of_blocks, threads_per_block&gt;&gt;&gt;();</span><br></pre></td></tr></table></figure>

<p>Given the example just above, the variables <code>gridDim.x</code>, <code>gridDim.y</code>, <code>blockDim.x</code>, and <code>blockDim.y</code> inside of <code>someKernel</code>, would all be equal to <code>16</code>.</p>
<h3 id="Exercise-Accelerate-2D-Matrix-Multiply-Application"><a href="#Exercise-Accelerate-2D-Matrix-Multiply-Application" class="headerlink" title="Exercise: Accelerate 2D Matrix Multiply Application"></a>Exercise: Accelerate 2D Matrix Multiply Application</h3><p>The file <a target="_blank" rel="noopener" href="http://ec2-18-191-146-97.us-east-2.compute.amazonaws.com/oiOcuiDi/edit/tasks/task1/task/01_AC_CUDA_C/08-matrix-multiply/01-matrix-multiply-2d.cu"><code>01-matrix-multiply-2d.cu</code></a> contains a host function <code>matrixMulCPU</code> which is fully functional. Your task is to build out the <code>matrixMulGPU</code>CUDA kernel. The source code will execute the matrix multiplication with both functions, and compare their answers to verify the correctness of the CUDA kernel you will be writing. Use the following guidelines to support your work and refer to <a target="_blank" rel="noopener" href="http://ec2-18-191-146-97.us-east-2.compute.amazonaws.com/oiOcuiDi/edit/tasks/task1/task/01_AC_CUDA_C/08-matrix-multiply/solutions/01-matrix-multiply-2d-solution.cu">the solution</a> if you get stuck:</p>
<ul>
<li>You will need to create an execution configuration whose arguments are both <code>dim3</code> values with the <code>x</code> and <code>y</code> dimensions set to greater than <code>1</code>.</li>
<li>Inside the body of the kernel, you will need to establish the running thread’s unique index within the grid per usual, but you should establish two indices for the thread: one for the x axis of the grid, and one for the y axis of the grid.</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N  64</span></span><br><span class="line"></span><br><span class="line"><span class="function">__global__ <span class="type">void</span> <span class="title">matrixMulGPU</span><span class="params">( <span class="type">int</span> * a, <span class="type">int</span> * b, <span class="type">int</span> * c )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Build out this kernel.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This CPU function already works, and will run to create a solution matrix</span></span><br><span class="line"><span class="comment"> * against which to verify your work building out the matrixMulGPU kernel.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">matrixMulCPU</span><span class="params">( <span class="type">int</span> * a, <span class="type">int</span> * b, <span class="type">int</span> * c )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> val = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>( <span class="type">int</span> row = <span class="number">0</span>; row &lt; N; ++row )</span><br><span class="line">    <span class="keyword">for</span>( <span class="type">int</span> col = <span class="number">0</span>; col &lt; N; ++col )</span><br><span class="line">    &#123;</span><br><span class="line">      val = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> ( <span class="type">int</span> k = <span class="number">0</span>; k &lt; N; ++k )</span><br><span class="line">        val += a[row * N + k] * b[k * N + col];</span><br><span class="line">      c[row * N + col] = val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> *a, *b, *c_cpu, *c_gpu; <span class="comment">// Allocate a solution matrix for both the CPU and the GPU operations</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> size = N * N * <span class="built_in">sizeof</span> (<span class="type">int</span>); <span class="comment">// Number of bytes of an N x N matrix</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Allocate memory</span></span><br><span class="line">  <span class="built_in">cudaMallocManaged</span> (&amp;a, size);</span><br><span class="line">  <span class="built_in">cudaMallocManaged</span> (&amp;b, size);</span><br><span class="line">  <span class="built_in">cudaMallocManaged</span> (&amp;c_cpu, size);</span><br><span class="line">  <span class="built_in">cudaMallocManaged</span> (&amp;c_gpu, size);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize memory; create 2D matrices</span></span><br><span class="line">  <span class="keyword">for</span>( <span class="type">int</span> row = <span class="number">0</span>; row &lt; N; ++row )</span><br><span class="line">    <span class="keyword">for</span>( <span class="type">int</span> col = <span class="number">0</span>; col &lt; N; ++col )</span><br><span class="line">    &#123;</span><br><span class="line">      a[row*N + col] = row;</span><br><span class="line">      b[row*N + col] = col+<span class="number">2</span>;</span><br><span class="line">      c_cpu[row*N + col] = <span class="number">0</span>;</span><br><span class="line">      c_gpu[row*N + col] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Assign `threads_per_block` and `number_of_blocks` 2D values</span></span><br><span class="line"><span class="comment">   * that can be used in matrixMulGPU above.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  dim3 threads_per_block;</span><br><span class="line">  dim3 number_of_blocks;</span><br><span class="line"></span><br><span class="line">  matrixMulGPU &lt;&lt;&lt; number_of_blocks, threads_per_block &gt;&gt;&gt; ( a, b, c_gpu );</span><br><span class="line"></span><br><span class="line">  <span class="built_in">cudaDeviceSynchronize</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Call the CPU version to check our work</span></span><br><span class="line">  <span class="built_in">matrixMulCPU</span>( a, b, c_cpu );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Compare the two answers to make sure they are equal</span></span><br><span class="line">  <span class="type">bool</span> error = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="type">int</span> row = <span class="number">0</span>; row &lt; N &amp;&amp; !error; ++row )</span><br><span class="line">    <span class="keyword">for</span>( <span class="type">int</span> col = <span class="number">0</span>; col &lt; N &amp;&amp; !error; ++col )</span><br><span class="line">      <span class="keyword">if</span> (c_cpu[row * N + col] != c_gpu[row * N + col])</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;FOUND ERROR at c[%d][%d]\n&quot;</span>, row, col);</span><br><span class="line">        error = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  <span class="keyword">if</span> (!error)</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Success!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Free all our allocated memory</span></span><br><span class="line">  <span class="built_in">cudaFree</span>(a); <span class="built_in">cudaFree</span>(b);</span><br><span class="line">  <span class="built_in">cudaFree</span>( c_cpu ); <span class="built_in">cudaFree</span>( c_gpu );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>Solution)</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N  64</span></span><br><span class="line"></span><br><span class="line"><span class="function">__global__ <span class="type">void</span> <span class="title">matrixMulGPU</span><span class="params">( <span class="type">int</span> * a, <span class="type">int</span> * b, <span class="type">int</span> * c )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> val = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> row = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">  <span class="type">int</span> col = blockIdx.y * blockDim.y + threadIdx.y;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (row &lt; N &amp;&amp; col &lt; N)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( <span class="type">int</span> k = <span class="number">0</span>; k &lt; N; ++k )</span><br><span class="line">      val += a[row * N + k] * b[k * N + col];</span><br><span class="line">    c[row * N + col] = val;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">matrixMulCPU</span><span class="params">( <span class="type">int</span> * a, <span class="type">int</span> * b, <span class="type">int</span> * c )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> val = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>( <span class="type">int</span> row = <span class="number">0</span>; row &lt; N; ++row )</span><br><span class="line">    <span class="keyword">for</span>( <span class="type">int</span> col = <span class="number">0</span>; col &lt; N; ++col )</span><br><span class="line">    &#123;</span><br><span class="line">      val = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> ( <span class="type">int</span> k = <span class="number">0</span>; k &lt; N; ++k )</span><br><span class="line">        val += a[row * N + k] * b[k * N + col];</span><br><span class="line">      c[row * N + col] = val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> *a, *b, *c_cpu, *c_gpu;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> size = N * N * <span class="built_in">sizeof</span> (<span class="type">int</span>); <span class="comment">// Number of bytes of an N x N matrix</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Allocate memory</span></span><br><span class="line">  <span class="built_in">cudaMallocManaged</span> (&amp;a, size);</span><br><span class="line">  <span class="built_in">cudaMallocManaged</span> (&amp;b, size);</span><br><span class="line">  <span class="built_in">cudaMallocManaged</span> (&amp;c_cpu, size);</span><br><span class="line">  <span class="built_in">cudaMallocManaged</span> (&amp;c_gpu, size);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize memory</span></span><br><span class="line">  <span class="keyword">for</span>( <span class="type">int</span> row = <span class="number">0</span>; row &lt; N; ++row )</span><br><span class="line">    <span class="keyword">for</span>( <span class="type">int</span> col = <span class="number">0</span>; col &lt; N; ++col )</span><br><span class="line">    &#123;</span><br><span class="line">      a[row*N + col] = row;</span><br><span class="line">      b[row*N + col] = col+<span class="number">2</span>;</span><br><span class="line">      c_cpu[row*N + col] = <span class="number">0</span>;</span><br><span class="line">      c_gpu[row*N + col] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">dim3 <span class="title">threads_per_block</span> <span class="params">(<span class="number">16</span>, <span class="number">16</span>, <span class="number">1</span>)</span></span>; <span class="comment">// A 16 x 16 block threads</span></span><br><span class="line">  <span class="function">dim3 <span class="title">number_of_blocks</span> <span class="params">((N / threads_per_block.x) + <span class="number">1</span>, (N / threads_per_block.y) + <span class="number">1</span>, <span class="number">1</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">  matrixMulGPU &lt;&lt;&lt; number_of_blocks, threads_per_block &gt;&gt;&gt; ( a, b, c_gpu );</span><br><span class="line"></span><br><span class="line">  <span class="built_in">cudaDeviceSynchronize</span>(); <span class="comment">// Wait for the GPU to finish before proceeding</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Call the CPU version to check our work</span></span><br><span class="line">  <span class="built_in">matrixMulCPU</span>( a, b, c_cpu );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Compare the two answers to make sure they are equal</span></span><br><span class="line">  <span class="type">bool</span> error = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="type">int</span> row = <span class="number">0</span>; row &lt; N &amp;&amp; !error; ++row )</span><br><span class="line">    <span class="keyword">for</span>( <span class="type">int</span> col = <span class="number">0</span>; col &lt; N &amp;&amp; !error; ++col )</span><br><span class="line">      <span class="keyword">if</span> (c_cpu[row * N + col] != c_gpu[row * N + col])</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;FOUND ERROR at c[%d][%d]\n&quot;</span>, row, col);</span><br><span class="line">        error = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  <span class="keyword">if</span> (!error)</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Success!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Free all our allocated memory</span></span><br><span class="line">  <span class="built_in">cudaFree</span>(a); <span class="built_in">cudaFree</span>(b);</span><br><span class="line">  <span class="built_in">cudaFree</span>( c_cpu ); <span class="built_in">cudaFree</span>( c_gpu );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Exercise-Accelerate-A-Thermal-Conductivity-Application"><a href="#Exercise-Accelerate-A-Thermal-Conductivity-Application" class="headerlink" title="Exercise: Accelerate A Thermal Conductivity Application"></a>Exercise: Accelerate A Thermal Conductivity Application</h3><p>In the following exercise, you will be accelerating an application that simulates the thermal conduction of silver in 2 dimensional space.</p>
<p>Convert the <code>step_kernel_mod</code> function inside <a target="_blank" rel="noopener" href="http://ec2-18-191-146-97.us-east-2.compute.amazonaws.com/oiOcuiDi/edit/tasks/task1/task/01_AC_CUDA_C/09-heat/01-heat-conduction.cu"><code>01-heat-conduction.cu</code></a> to execute on the GPU, and modify the <code>main</code> function to properly allocate data for use on CPU and GPU. The <code>step_kernel_ref</code> function executes on the CPU and is used for error checking. Because this code involves floating point calculations, different processors, or even simply reording operations on the same processor, can result in slightly different results. For this reason the error checking code uses an error threshold, instead of looking for an exact match. Refer to <a target="_blank" rel="noopener" href="http://ec2-18-191-146-97.us-east-2.compute.amazonaws.com/oiOcuiDi/edit/tasks/task1/task/01_AC_CUDA_C/09-heat/solutions/01-heat-conduction-solution.cu">the solution</a> if you get stuck.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Simple define to index into a 1D array from 2D space</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> I2D(num, c, r) ((r)*(num)+(c))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * `step_kernel_mod` is currently a direct copy of the CPU reference solution</span></span><br><span class="line"><span class="comment"> * `step_kernel_ref` below. Accelerate it to run as a CUDA kernel.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">step_kernel_mod</span><span class="params">(<span class="type">int</span> ni, <span class="type">int</span> nj, <span class="type">float</span> fact, <span class="type">float</span>* temp_in, <span class="type">float</span>* temp_out)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> i00, im10, ip10, i0m1, i0p1;</span><br><span class="line">  <span class="type">float</span> d2tdx2, d2tdy2;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// loop over all points in domain (except boundary)</span></span><br><span class="line">  <span class="keyword">for</span> ( <span class="type">int</span> j=<span class="number">1</span>; j &lt; nj<span class="number">-1</span>; j++ ) &#123;</span><br><span class="line">    <span class="keyword">for</span> ( <span class="type">int</span> i=<span class="number">1</span>; i &lt; ni<span class="number">-1</span>; i++ ) &#123;</span><br><span class="line">      <span class="comment">// find indices into linear memory</span></span><br><span class="line">      <span class="comment">// for central point and neighbours</span></span><br><span class="line">      i00 = <span class="built_in">I2D</span>(ni, i, j);</span><br><span class="line">      im10 = <span class="built_in">I2D</span>(ni, i<span class="number">-1</span>, j);</span><br><span class="line">      ip10 = <span class="built_in">I2D</span>(ni, i+<span class="number">1</span>, j);</span><br><span class="line">      i0m1 = <span class="built_in">I2D</span>(ni, i, j<span class="number">-1</span>);</span><br><span class="line">      i0p1 = <span class="built_in">I2D</span>(ni, i, j+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// evaluate derivatives</span></span><br><span class="line">      d2tdx2 = temp_in[im10]<span class="number">-2</span>*temp_in[i00]+temp_in[ip10];</span><br><span class="line">      d2tdy2 = temp_in[i0m1]<span class="number">-2</span>*temp_in[i00]+temp_in[i0p1];</span><br><span class="line"></span><br><span class="line">      <span class="comment">// update temperatures</span></span><br><span class="line">      temp_out[i00] = temp_in[i00]+fact*(d2tdx2 + d2tdy2);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">step_kernel_ref</span><span class="params">(<span class="type">int</span> ni, <span class="type">int</span> nj, <span class="type">float</span> fact, <span class="type">float</span>* temp_in, <span class="type">float</span>* temp_out)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> i00, im10, ip10, i0m1, i0p1;</span><br><span class="line">  <span class="type">float</span> d2tdx2, d2tdy2;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// loop over all points in domain (except boundary)</span></span><br><span class="line">  <span class="keyword">for</span> ( <span class="type">int</span> j=<span class="number">1</span>; j &lt; nj<span class="number">-1</span>; j++ ) &#123;</span><br><span class="line">    <span class="keyword">for</span> ( <span class="type">int</span> i=<span class="number">1</span>; i &lt; ni<span class="number">-1</span>; i++ ) &#123;</span><br><span class="line">      <span class="comment">// find indices into linear memory</span></span><br><span class="line">      <span class="comment">// for central point and neighbours</span></span><br><span class="line">      i00 = <span class="built_in">I2D</span>(ni, i, j);</span><br><span class="line">      im10 = <span class="built_in">I2D</span>(ni, i<span class="number">-1</span>, j);</span><br><span class="line">      ip10 = <span class="built_in">I2D</span>(ni, i+<span class="number">1</span>, j);</span><br><span class="line">      i0m1 = <span class="built_in">I2D</span>(ni, i, j<span class="number">-1</span>);</span><br><span class="line">      i0p1 = <span class="built_in">I2D</span>(ni, i, j+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// evaluate derivatives</span></span><br><span class="line">      d2tdx2 = temp_in[im10]<span class="number">-2</span>*temp_in[i00]+temp_in[ip10];</span><br><span class="line">      d2tdy2 = temp_in[i0m1]<span class="number">-2</span>*temp_in[i00]+temp_in[i0p1];</span><br><span class="line"></span><br><span class="line">      <span class="comment">// update temperatures</span></span><br><span class="line">      temp_out[i00] = temp_in[i00]+fact*(d2tdx2 + d2tdy2);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> istep;</span><br><span class="line">  <span class="type">int</span> nstep = <span class="number">200</span>; <span class="comment">// number of time steps</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Specify our 2D dimensions</span></span><br><span class="line">  <span class="type">const</span> <span class="type">int</span> ni = <span class="number">200</span>;</span><br><span class="line">  <span class="type">const</span> <span class="type">int</span> nj = <span class="number">100</span>;</span><br><span class="line">  <span class="type">float</span> tfac = <span class="number">8.418e-5</span>; <span class="comment">// thermal diffusivity of silver</span></span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> *temp1_ref, *temp2_ref, *temp1, *temp2, *temp_tmp;</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">int</span> size = ni * nj * <span class="built_in">sizeof</span>(<span class="type">float</span>);</span><br><span class="line"></span><br><span class="line">  temp1_ref = (<span class="type">float</span>*)<span class="built_in">malloc</span>(size);</span><br><span class="line">  temp2_ref = (<span class="type">float</span>*)<span class="built_in">malloc</span>(size);</span><br><span class="line">  temp1 = (<span class="type">float</span>*)<span class="built_in">malloc</span>(size);</span><br><span class="line">  temp2 = (<span class="type">float</span>*)<span class="built_in">malloc</span>(size);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize with random data</span></span><br><span class="line">  <span class="keyword">for</span>( <span class="type">int</span> i = <span class="number">0</span>; i &lt; ni*nj; ++i) &#123;</span><br><span class="line">    temp1_ref[i] = temp2_ref[i] = temp1[i] = temp2[i] = (<span class="type">float</span>)<span class="built_in">rand</span>()/(<span class="type">float</span>)(RAND_MAX/<span class="number">100.0f</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Execute the CPU-only reference version</span></span><br><span class="line">  <span class="keyword">for</span> (istep=<span class="number">0</span>; istep &lt; nstep; istep++) &#123;</span><br><span class="line">    <span class="built_in">step_kernel_ref</span>(ni, nj, tfac, temp1_ref, temp2_ref);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// swap the temperature pointers</span></span><br><span class="line">    temp_tmp = temp1_ref;</span><br><span class="line">    temp1_ref = temp2_ref;</span><br><span class="line">    temp2_ref= temp_tmp;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Execute the modified version using same data</span></span><br><span class="line">  <span class="keyword">for</span> (istep=<span class="number">0</span>; istep &lt; nstep; istep++) &#123;</span><br><span class="line">    <span class="built_in">step_kernel_mod</span>(ni, nj, tfac, temp1, temp2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// swap the temperature pointers</span></span><br><span class="line">    temp_tmp = temp1;</span><br><span class="line">    temp1 = temp2;</span><br><span class="line">    temp2= temp_tmp;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> maxError = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// Output should always be stored in the temp1 and temp1_ref at this point</span></span><br><span class="line">  <span class="keyword">for</span>( <span class="type">int</span> i = <span class="number">0</span>; i &lt; ni*nj; ++i ) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">abs</span>(temp1[i]-temp1_ref[i]) &gt; maxError) &#123; maxError = <span class="built_in">abs</span>(temp1[i]-temp1_ref[i]); &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check and see if our maxError is greater than an error bound</span></span><br><span class="line">  <span class="keyword">if</span> (maxError &gt; <span class="number">0.0005f</span>)</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Problem! The Max Error of %.5f is NOT within acceptable bounds.\n&quot;</span>, maxError);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;The Max Error of %.5f is within acceptable bounds.\n&quot;</span>, maxError);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>( temp1_ref );</span><br><span class="line">  <span class="built_in">free</span>( temp2_ref );</span><br><span class="line">  <span class="built_in">free</span>( temp1 );</span><br><span class="line">  <span class="built_in">free</span>( temp2 );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>Solution)</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Simple define to index into a 1D array from 2D space</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> I2D(num, c, r) ((r)*(num)+(c))</span></span><br><span class="line"></span><br><span class="line"><span class="function">__global__</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">step_kernel_mod</span><span class="params">(<span class="type">int</span> ni, <span class="type">int</span> nj, <span class="type">float</span> fact, <span class="type">float</span>* temp_in, <span class="type">float</span>* temp_out)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> i00, im10, ip10, i0m1, i0p1;</span><br><span class="line">  <span class="type">float</span> d2tdx2, d2tdy2;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> j = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">  <span class="type">int</span> i = blockIdx.y * blockDim.y + threadIdx.y;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// loop over all points in domain (except boundary)</span></span><br><span class="line">  <span class="keyword">if</span> (j &gt; <span class="number">0</span> &amp;&amp; i &gt; <span class="number">0</span> &amp;&amp; j &lt; nj<span class="number">-1</span> &amp;&amp; i &lt; ni<span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="comment">// find indices into linear memory</span></span><br><span class="line">    <span class="comment">// for central point and neighbours</span></span><br><span class="line">    i00 = <span class="built_in">I2D</span>(ni, i, j);</span><br><span class="line">    im10 = <span class="built_in">I2D</span>(ni, i<span class="number">-1</span>, j);</span><br><span class="line">    ip10 = <span class="built_in">I2D</span>(ni, i+<span class="number">1</span>, j);</span><br><span class="line">    i0m1 = <span class="built_in">I2D</span>(ni, i, j<span class="number">-1</span>);</span><br><span class="line">    i0p1 = <span class="built_in">I2D</span>(ni, i, j+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// evaluate derivatives</span></span><br><span class="line">    d2tdx2 = temp_in[im10]<span class="number">-2</span>*temp_in[i00]+temp_in[ip10];</span><br><span class="line">    d2tdy2 = temp_in[i0m1]<span class="number">-2</span>*temp_in[i00]+temp_in[i0p1];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update temperatures</span></span><br><span class="line">    temp_out[i00] = temp_in[i00]+fact*(d2tdx2 + d2tdy2);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">step_kernel_ref</span><span class="params">(<span class="type">int</span> ni, <span class="type">int</span> nj, <span class="type">float</span> fact, <span class="type">float</span>* temp_in, <span class="type">float</span>* temp_out)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> i00, im10, ip10, i0m1, i0p1;</span><br><span class="line">  <span class="type">float</span> d2tdx2, d2tdy2;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// loop over all points in domain (except boundary)</span></span><br><span class="line">  <span class="keyword">for</span> ( <span class="type">int</span> j=<span class="number">1</span>; j &lt; nj<span class="number">-1</span>; j++ ) &#123;</span><br><span class="line">    <span class="keyword">for</span> ( <span class="type">int</span> i=<span class="number">1</span>; i &lt; ni<span class="number">-1</span>; i++ ) &#123;</span><br><span class="line">      <span class="comment">// find indices into linear memory</span></span><br><span class="line">      <span class="comment">// for central point and neighbours</span></span><br><span class="line">      i00 = <span class="built_in">I2D</span>(ni, i, j);</span><br><span class="line">      im10 = <span class="built_in">I2D</span>(ni, i<span class="number">-1</span>, j);</span><br><span class="line">      ip10 = <span class="built_in">I2D</span>(ni, i+<span class="number">1</span>, j);</span><br><span class="line">      i0m1 = <span class="built_in">I2D</span>(ni, i, j<span class="number">-1</span>);</span><br><span class="line">      i0p1 = <span class="built_in">I2D</span>(ni, i, j+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// evaluate derivatives</span></span><br><span class="line">      d2tdx2 = temp_in[im10]<span class="number">-2</span>*temp_in[i00]+temp_in[ip10];</span><br><span class="line">      d2tdy2 = temp_in[i0m1]<span class="number">-2</span>*temp_in[i00]+temp_in[i0p1];</span><br><span class="line"></span><br><span class="line">      <span class="comment">// update temperatures</span></span><br><span class="line">      temp_out[i00] = temp_in[i00]+fact*(d2tdx2 + d2tdy2);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> istep;</span><br><span class="line">  <span class="type">int</span> nstep = <span class="number">200</span>; <span class="comment">// number of time steps</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Specify our 2D dimensions</span></span><br><span class="line">  <span class="type">const</span> <span class="type">int</span> ni = <span class="number">200</span>;</span><br><span class="line">  <span class="type">const</span> <span class="type">int</span> nj = <span class="number">100</span>;</span><br><span class="line">  <span class="type">float</span> tfac = <span class="number">8.418e-5</span>; <span class="comment">// thermal diffusivity of silver</span></span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> *temp1_ref, *temp2_ref, *temp1, *temp2, *temp_tmp;</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">int</span> size = ni * nj * <span class="built_in">sizeof</span>(<span class="type">float</span>);</span><br><span class="line"></span><br><span class="line">  temp1_ref = (<span class="type">float</span>*)<span class="built_in">malloc</span>(size);</span><br><span class="line">  temp2_ref = (<span class="type">float</span>*)<span class="built_in">malloc</span>(size);</span><br><span class="line">  <span class="built_in">cudaMallocManaged</span>(&amp;temp1, size);</span><br><span class="line">  <span class="built_in">cudaMallocManaged</span>(&amp;temp2, size);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize with random data</span></span><br><span class="line">  <span class="keyword">for</span>( <span class="type">int</span> i = <span class="number">0</span>; i &lt; ni*nj; ++i) &#123;</span><br><span class="line">    temp1_ref[i] = temp2_ref[i] = temp1[i] = temp2[i] = (<span class="type">float</span>)<span class="built_in">rand</span>()/(<span class="type">float</span>)(RAND_MAX/<span class="number">100.0f</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Execute the CPU-only reference version</span></span><br><span class="line">  <span class="keyword">for</span> (istep=<span class="number">0</span>; istep &lt; nstep; istep++) &#123;</span><br><span class="line">    <span class="built_in">step_kernel_ref</span>(ni, nj, tfac, temp1_ref, temp2_ref);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// swap the temperature pointers</span></span><br><span class="line">    temp_tmp = temp1_ref;</span><br><span class="line">    temp1_ref = temp2_ref;</span><br><span class="line">    temp2_ref= temp_tmp;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">dim3 <span class="title">tblocks</span><span class="params">(<span class="number">32</span>, <span class="number">16</span>, <span class="number">1</span>)</span></span>;</span><br><span class="line">  <span class="function">dim3 <span class="title">grid</span><span class="params">((nj/tblocks.x)+<span class="number">1</span>, (ni/tblocks.y)+<span class="number">1</span>, <span class="number">1</span>)</span></span>;</span><br><span class="line">  cudaError_t ierrSync, ierrAsync;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Execute the modified version using same data</span></span><br><span class="line">  <span class="keyword">for</span> (istep=<span class="number">0</span>; istep &lt; nstep; istep++) &#123;</span><br><span class="line">    step_kernel_mod&lt;&lt;&lt; grid, tblocks &gt;&gt;&gt;(ni, nj, tfac, temp1, temp2);</span><br><span class="line"></span><br><span class="line">    ierrSync = <span class="built_in">cudaGetLastError</span>();</span><br><span class="line">    ierrAsync = <span class="built_in">cudaDeviceSynchronize</span>(); <span class="comment">// Wait for the GPU to finish</span></span><br><span class="line">    <span class="keyword">if</span> (ierrSync != cudaSuccess) &#123; <span class="built_in">printf</span>(<span class="string">&quot;Sync error: %s\n&quot;</span>, <span class="built_in">cudaGetErrorString</span>(ierrSync)); &#125;</span><br><span class="line">    <span class="keyword">if</span> (ierrAsync != cudaSuccess) &#123; <span class="built_in">printf</span>(<span class="string">&quot;Async error: %s\n&quot;</span>, <span class="built_in">cudaGetErrorString</span>(ierrAsync)); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// swap the temperature pointers</span></span><br><span class="line">    temp_tmp = temp1;</span><br><span class="line">    temp1 = temp2;</span><br><span class="line">    temp2= temp_tmp;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> maxError = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// Output should always be stored in the temp1 and temp1_ref at this point</span></span><br><span class="line">  <span class="keyword">for</span>( <span class="type">int</span> i = <span class="number">0</span>; i &lt; ni*nj; ++i ) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">abs</span>(temp1[i]-temp1_ref[i]) &gt; maxError) &#123; maxError = <span class="built_in">abs</span>(temp1[i]-temp1_ref[i]); &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check and see if our maxError is greater than an error bound</span></span><br><span class="line">  <span class="keyword">if</span> (maxError &gt; <span class="number">0.0005f</span>)</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Problem! The Max Error of %.5f is NOT within acceptable bounds.\n&quot;</span>, maxError);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;The Max Error of %.5f is within acceptable bounds.\n&quot;</span>, maxError);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>( temp1_ref );</span><br><span class="line">  <span class="built_in">free</span>( temp2_ref );</span><br><span class="line">  <span class="built_in">cudaFree</span>( temp1 );</span><br><span class="line">  <span class="built_in">cudaFree</span>( temp2 );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Code&amp; Vision"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Code&amp; Vision</p><p class="is-size-6 is-block">Wide Stack Developer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Korea</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">3</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">2</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">7</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ppoffice" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/ppoffice"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/CUDA/"><span class="level-start"><span class="level-item">CUDA</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/code/"><span class="level-start"><span class="level-item">code</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-01-20T12:42:47.922Z">2023-01-20</time></p><p class="title"><a href="/2023/01/20/hello-world/">Hello World</a></p><p class="categories"><a href="/categories/code/">code</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-01-20T04:14:55.000Z">2023-01-20</time></p><p class="title"><a href="/2023/01/20/cuda-basic-1/">cuda-basic-1</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2018-11-07T15:00:00.000Z">2018-11-08</time></p><p class="title"><a href="/2018/11/08/cuda-tutorials-1/">NVIDIA CUDA 기초 튜토리얼 (1)</a></p><p class="categories"><a href="/categories/CUDA/">CUDA</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/01/"><span class="level-start"><span class="level-item">January 2023</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/11/"><span class="level-start"><span class="level-item">November 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/CUDA/"><span class="tag">CUDA</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NVIDIA/"><span class="tag">NVIDIA</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/accelerated-computing/"><span class="tag">accelerated computing</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/c/"><span class="tag">c++</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/code/"><span class="tag">code</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cuda/"><span class="tag">cuda</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tutorial/"><span class="tag">tutorial</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Code&amp; Vision" height="28"></a><p class="is-size-7"><span>&copy; 2023 Wide Stack Developer</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>